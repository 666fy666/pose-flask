# 肩关节体格检查AI评估系统(flask)

## 项目概述

这是一个基于Flask的肩关节体格检查AI评估系统，集成了患者管理、多角度视频AI分析等功能。系统采用前后端分离架构，提供直观的用户界面和强大的后端处理能力。

## 系统架构

### 技术栈
- **后端**: Flask + SQLAlchemy + SQLite
- **前端**: HTML5 + CSS3 + JavaScript + Bootstrap 5
- **AI分析**: OpenCV + Ultralytics YOLO
- **文件处理**: 视频上传、存储、预览
- **数据库**: SQLite (patients.db, user.db)

### 目录结构
```
pose-flask/
├── app.py                 # 主应用文件
├── config.yaml           # 用户配置文件
├── requirements.txt      # Python依赖
├── patients.db          # 患者数据库
├── user.db              # 用户数据库
├── patients_data/       # 患者数据存储目录
│   └── {id}-{姓名}/     # 患者专属文件夹
│       ├── videos/      # 视频文件存储
│       ├── analysis_results/  # 分析结果
│       └── reports/     # 报告文件
├── templates/           # HTML模板
├── static/             # 静态资源
│   ├── css/           # 样式文件
│   └── js/            # JavaScript文件
└── README.md          # 项目说明文档
```

## 核心功能

### 1. 用户认证系统
- **登录/注册**: 支持用户注册和登录
- **会话管理**: 基于Flask Session的安全会话管理
- **权限控制**: 登录验证装饰器保护敏感路由

### 2. 患者管理系统
- **患者信息管理**: 完整的患者信息录入、编辑、删除
- **患者搜索**: 支持按姓名、性别、年龄范围搜索
- **分页显示**: 支持大量患者数据的分页浏览
- **数据导出**: 支持患者数据导出功能

#### 患者信息字段
- 基本信息: 姓名、年龄、性别、身高、体重
- 医疗信息: 诊断、治疗记录、病程、项目
- 地址信息: 详细地址
- 记录信息: 填写人、记录时间
- AI评估: 运动评分、综合评分、分析报告

### 3. AI视频分析系统

#### 视频上传功能
- **多角度视频**: 支持正面、侧面、背面三个角度的视频上传
- **文件验证**: 自动验证文件格式(MP4, AVI, MOV)和大小(100MB限制)
- **智能预览**: 自动检测患者视频并加载预览
- **重新上传**: 支持覆盖现有视频文件，提供确认对话框
- **视频删除**: 支持删除已上传的视频文件

#### 视频管理特性
- **患者专属存储**: 每个患者在`patients_data/{id}-{姓名}/videos/`目录下存储视频
- **标准化命名**: 视频自动重命名为`front.mp4`、`side.mp4`、`back.mp4`
- **状态同步**: 前端状态与后端文件系统实时同步
- **批量操作**: 支持批量上传多个视频文件

#### AI姿态分析功能
- **实时姿态检测**: 使用YOLO模型进行人体关键点检测
- **角度计算**: 自动计算肩关节角度、角速度、角加速度
- **多角度分析**: 分别分析三个角度的视频，计算不同指标
- **数据可视化**: 生成角度变化曲线、角度-速度分布图等
- **智能评估**: 基于分析数据自动生成功能评分和评估报告

#### 分析结果管理
- **结果存储**: 分析结果保存在`patients_data/{id}-{姓名}/analysis_results/`目录
- **图表生成**: 自动生成PNG格式的分析图表
- **标注视频**: 生成带关键点和角度标注的视频文件
- **数据导出**: 分析数据以JSON格式保存，便于后续处理
- **报告生成**: 自动生成Word格式的详细分析报告

#### 报告系统
- **Word报告**: 自动生成包含图表、数据表格的Word格式报告
- **综合评估**: 基于多角度数据生成功能评分和评估结果
- **建议生成**: 根据分析结果自动生成康复建议
- **报告存储**: 报告保存在`patients_data/{id}-{姓名}/reports/`目录

#### 视频预览更新机制
- **自动更新**: 上传、重新上传或删除视频后自动刷新预览界面
- **状态同步**: 前端预览状态与后端文件系统实时同步
- **智能检测**: 选择患者时自动检测并加载已有视频
- **手动刷新**: 提供"刷新预览"按钮，用户可手动更新预览内容
- **错误处理**: 视频加载失败时提供友好的错误提示

#### 患者选择状态持久化
- **自动保存**: 选择患者后自动保存到浏览器本地存储
- **自动恢复**: 刷新页面后自动恢复之前选择的患者
- **过期管理**: 患者选择数据24小时后自动过期清除
- **智能验证**: 恢复时检查患者是否仍然存在于系统中
- **手动清除**: 提供清除按钮，用户可手动清除选择状态
- **状态同步**: 页面卸载时自动保存当前选择状态

### 4. 用户界面特性

#### 患者选择界面
- **模态框设计**: 美观的患者选择模态框
- **搜索功能**: 实时搜索患者姓名
- **状态提示**: 未选患者时显示醒目提示
- **选中状态**: 选中患者时显示患者信息卡片
- **状态持久化**: 患者选择自动保存到浏览器本地存储
- **自动恢复**: 刷新页面后自动恢复之前选择的患者
- **手动清除**: 提供清除患者选择功能

#### 视频上传界面
- **下拉式设计**: 可展开收起的视频上传区域
- **状态指示**: 清晰的上传状态指示器
- **进度显示**: 实时上传进度条
- **操作按钮**: 重新上传和删除按钮

#### 视频预览界面
- **自动加载**: 检测到视频后自动加载预览
- **实时更新**: 上传、重新上传或删除视频后自动更新预览界面
- **手动刷新**: 提供刷新预览按钮，确保预览内容最新
- **响应式设计**: 适配不同屏幕尺寸
- **交互优化**: 悬停效果和动画

## API接口文档

### 患者管理API

#### 获取患者列表
```
GET /api/patients
参数: page, page_size, search, gender, age_range
返回: 患者列表数据，包含分页信息
```

#### 创建患者
```
POST /api/patients
参数: 患者信息JSON
返回: 创建成功状态和患者ID
```

#### 获取患者详情
```
GET /api/patients/{patient_id}
返回: 患者详细信息
```

#### 更新患者信息
```
PUT /api/patients/{patient_id}
参数: 更新的患者信息JSON
返回: 更新成功状态
```

#### 删除患者
```
DELETE /api/patients/{patient_id}
返回: 删除成功状态和文件夹删除信息
功能: 删除患者记录的同时自动删除患者的文件夹及其所有内容
```

### 视频管理API

#### 上传视频
```
POST /api/upload_video
参数: video文件, angle角度, patientId患者ID
返回: 上传成功状态和文件信息
特性: 自动覆盖现有文件，返回覆盖状态
```

#### 检查患者视频
```
GET /api/patients/{patient_id}/videos/check
返回: 三个角度视频的存在状态和URL
```

#### 获取视频文件
```
GET /api/patients/{patient_id}/videos/{filename}
返回: 视频文件流
```

#### 删除视频文件
```
DELETE /api/patients/{patient_id}/videos/{filename}
返回: 删除成功状态
```

### 分析API

#### 开始分析
```
POST /api/analyze_video
参数: videos视频信息, analysisType分析类型, confidenceThreshold置信度阈值, patientId患者ID
返回: 分析结果
```

#### 停止分析
```
POST /api/stop_analysis/{analysis_id}
返回: 停止成功状态
```

#### 导出结果
```
GET /api/export_results/{analysis_id}
返回: ZIP格式的分析结果文件
```

#### 获取患者分析结果
```
GET /api/patients/{patient_id}/analysis_results
返回: 患者的分析结果、图表、视频和报告列表
```

#### 获取分析结果文件
```
GET /api/patients/{patient_id}/analysis_results/{filename}
返回: 分析结果文件（图表、标注视频等）
```

#### 获取患者报告
```
GET /api/patients/{patient_id}/reports/{filename}
返回: Word格式的分析报告文件
```

## 安装和部署

### 环境要求
- Python 3.7+
- Flask 2.0+
- 其他依赖见requirements.txt

### 安装步骤
1. 克隆项目到本地
2. 安装Python依赖: `pip install -r requirements.txt`
3. 配置config.yaml文件
4. 运行应用: `python app.py`

### 配置说明
在`config.yaml`中配置用户信息：
```yaml
credentials:
  usernames:
    admin:
      email: admin@example.com
      name: 管理员
      password: admin123
      role: admin
```

## 使用指南

### 1. 患者管理
1. 登录系统后进入数据管理页面
2. 点击"添加患者"创建新患者
3. 填写患者基本信息
4. 使用搜索和筛选功能查找患者
5. 点击编辑或删除按钮管理患者信息

### 2. AI视频分析
1. 进入AI视频分析页面
2. 选择患者（如无患者会提示创建）
3. 上传三个角度的视频文件
4. 系统自动检测并预览视频
5. 点击"开始分析"进行AI评估
6. 查看分析结果并导出报告

**注意**: 患者选择会自动保存，刷新页面（F5）后会自动恢复之前选择的患者。

### 3. 视频重新上传
1. 在视频上传区域点击"重新上传"按钮
2. 系统会提示确认覆盖现有文件
3. 选择新视频文件进行上传
4. 上传完成后视频预览会自动更新

### 4. 视频删除
1. 在视频上传区域点击"删除"按钮
2. 确认删除操作
3. 视频文件将从服务器删除
4. 界面状态会同步更新

## 系统特性

### 数据安全
- 用户认证和会话管理
- 文件上传验证和安全检查
- 数据库事务处理

### 用户体验
- 响应式设计，支持移动端
- 实时状态反馈
- 直观的操作界面
- 完善的错误处理

### 系统性能
- 文件大小限制和格式验证
- 分页加载大量数据
- 异步文件处理
- 缓存机制优化

### 可扩展性
- 模块化代码结构
- 标准化的API接口
- 配置化的系统参数
- 支持多种文件格式

## 故障排除

### 常见问题
1. **视频上传失败**: 检查文件格式和大小限制
2. **患者选择问题**: 确保已创建患者记录
3. **分析失败**: 检查视频文件完整性
4. **权限错误**: 确认用户登录状态
5. **Figure对象错误**: 如果遇到"'Figure' object has no attribute 'close'"错误，请确保使用最新版本的代码，该问题已在v2.4.0中修复
6. **JSON序列化错误**: 如果遇到"Object of type float32 is not JSON serializable"错误，请确保使用最新版本的代码，该问题已在v2.5.0中修复
7. **前端显示错误**: 如果遇到"Cannot read properties of undefined (reading 'front')"错误，请确保使用最新版本的代码，该问题已在v2.6.0中修复
8. **视频播放问题**: 如果标注视频无法播放或没有时长，请确保使用最新版本的代码，该问题已在v2.6.0中修复

### 日志查看
系统运行日志会显示在控制台，包含错误信息和调试信息。

## 更新日志

### v2.8.1 (最新) - 修复文件访问路径问题
- ✅ **修复API路径**: 修复分析结果文件访问路径，确保前端能正确访问文件
- ✅ **路径转换优化**: 将文件系统路径转换为正确的API路径
- ✅ **文件访问修复**: 解决图表和标注视频404错误问题
- ✅ **系统稳定性**: 确保分析结果文件能正常下载和查看

### v2.8.0 - 视频格式优化
- ✅ **统一AVI格式**: 只使用AVI格式保存标注视频，确保播放兼容性
- ✅ **默认完整视频**: 默认保存完整视频，去掉采样视频选项
- ✅ **简化用户界面**: 移除视频保存选项，简化操作流程
- ✅ **优化系统性能**: 减少不必要的选项，提高系统稳定性
- ✅ **兼容性提升**: 解决MP4格式播放问题，确保视频正常播放

### v2.7.0 - 完整视频保存功能
- ✅ **完整视频保存选项**: 新增保存完整视频功能，时长与原视频一致
- ✅ **智能内存管理**: 提供完整视频和采样视频两种模式，用户可根据需要选择
- ✅ **前端控制界面**: 在分析控制区域添加视频保存选项复选框
- ✅ **优化视频质量**: 完整视频模式保存所有帧，确保分析结果完整准确
- ✅ **系统性能优化**: 采样视频模式可节省内存，适合长视频分析

### v2.6.0 - 修复前端显示和视频保存问题
- ✅ **修复前端数据结构错误**: 解决了"Cannot read properties of undefined (reading 'front')"错误
- ✅ **优化视频保存质量**: 改进标注视频的保存机制，提高视频播放兼容性
- ✅ **增强视频编码器支持**: 添加多种视频编码器支持，确保视频能正常播放
- ✅ **改进分析结果显示**: 优化前端分析结果的显示逻辑和文件下载功能
- ✅ **系统稳定性提升**: 解决了AI视频分析结果在前端的显示问题

### v2.5.0 - 修复JSON序列化问题
- ✅ **修复numpy类型错误**: 解决了"Object of type float32 is not JSON serializable"错误
- ✅ **添加JSON序列化器**: 创建了专门的JSON序列化器处理numpy数据类型
- ✅ **类型转换优化**: 确保所有numpy类型在JSON序列化前转换为Python原生类型
- ✅ **系统稳定性提升**: 解决了AI视频分析结果返回时的序列化问题

### v2.4.0 - 修复分析失败问题
- ✅ **修复Figure对象错误**: 修复了matplotlib Figure对象close()方法调用错误
- ✅ **添加matplotlib导入**: 在video_analyzer.py中添加了必要的matplotlib导入
- ✅ **改进错误处理**: 优化了图表生成和关闭的错误处理机制
- ✅ **系统稳定性提升**: 解决了AI视频分析过程中的崩溃问题

### v2.3.0 - 患者删除功能增强
- ✅ **患者文件夹自动删除**: 删除患者记录时自动删除患者的文件夹及其所有内容
- ✅ **删除状态反馈**: 提供详细的删除操作反馈信息
- ✅ **错误处理优化**: 即使文件夹删除失败，患者记录仍能正常删除
- ✅ **数据完整性**: 确保患者数据完全清理，避免残留文件

### v2.2.0 - 患者选择状态持久化
- ✅ **患者选择持久化**: 使用localStorage保存患者选择状态
- ✅ **自动恢复功能**: 刷新页面（F5）后自动恢复之前选择的患者
- ✅ **状态过期管理**: 患者选择数据24小时后自动过期
- ✅ **手动清除功能**: 添加清除患者选择按钮
- ✅ **智能状态检查**: 恢复时检查患者是否仍然存在
- ✅ **用户体验优化**: 添加状态保存提示和操作反馈

### v2.1.0 - 视频预览优化更新
- ✅ **视频预览实时更新**: 上传、重新上传或删除视频后自动更新预览界面
- ✅ **智能预览刷新**: 新增`refreshVideoPreviews()`函数，确保预览内容最新
- ✅ **手动刷新按钮**: 在视频预览区域添加"刷新预览"按钮
- ✅ **状态同步优化**: 改进前端状态与后端文件系统的同步机制
- ✅ **用户体验提升**: 优化视频预览的加载和显示逻辑
- ✅ **错误处理增强**: 改进视频加载失败时的错误处理

### v2.0.0
- ✅ 新增视频重新上传功能
- ✅ 新增视频删除功能
- ✅ 优化视频预览更新逻辑
- ✅ 改进用户界面交互体验
- ✅ 增强错误处理和状态管理
- ✅ 完善系统文档

### v1.0.0
- ✅ 基础患者管理功能
- ✅ 视频上传和分析功能
- ✅ 用户认证系统
- ✅ 基础UI界面

## 技术支持

如有问题或建议，请联系开发团队。

---

**注意**: 本系统仅供医疗辅助使用，最终诊断应由专业医生进行。 