# 肩关节体格检查AI评估系统 v2.0.0

## 项目概述

肩关节体格检查AI评估系统是一个基于Flask的医疗辅助应用，专门用于肩关节功能评估。系统集成了患者管理、多角度视频AI分析、智能报告生成等功能，为医疗工作者提供专业的肩关节功能评估工具。

### 核心特性
- 🏥 **专业医疗评估**: 基于YOLO姿态检测的肩关节功能分析
- 📊 **多角度分析**: 支持正面、侧面、背面三个角度的视频分析
- 📈 **智能报告**: 自动生成包含图表和评估建议的Word报告
- 👥 **患者管理**: 完整的患者信息管理和历史记录追踪
- 🔒 **安全认证**: 基于Flask Session的用户认证系统
- 📱 **响应式界面**: 适配桌面和移动设备的现代化UI

## 系统架构

### 技术栈
- **后端框架**: Flask 2.3.3 + SQLAlchemy 3.0.5
- **前端技术**: HTML5 + CSS3 + JavaScript + Bootstrap 5
- **AI引擎**: Ultralytics YOLO 8.0.196 + OpenCV 4.8.1
- **数据处理**: NumPy 1.24.3 + Pandas 2.0.3 + Matplotlib 3.7.2
- **文档生成**: Python-docx 0.8.11
- **数据库**: SQLite (patients.db, user.db)
- **配置管理**: PyYAML 6.0.1

### 项目结构
```
pose-flask/
├── app.py                    # Flask主应用文件
├── config.yaml              # 用户配置文件
├── requirements.txt         # Python依赖包
├── patients.db             # 患者数据库
├── user.db                 # 用户数据库
├── pose_analysis/          # AI分析核心模块
│   ├── __init__.py
│   ├── video_analyzer.py   # 视频分析器
│   ├── data_processor.py   # 数据处理器
│   ├── pose_detector.py    # 姿态检测器
│   ├── report_generator.py # 报告生成器
│   ├── json_serializer.py  # JSON序列化器
│   ├── utils.py           # 工具函数
│   ├── config.py          # 分析配置
│   └── font_config.py     # 字体配置
├── templates/              # HTML模板
│   ├── base.html          # 基础模板
│   ├── index.html         # 首页
│   ├── login.html         # 登录页
│   ├── register.html      # 注册页
│   ├── data_management.html # 数据管理页
│   └── ai_video.html      # AI视频分析页
├── static/                # 静态资源
│   ├── css/              # 样式文件
│   ├── js/               # JavaScript文件
│   │   ├── main.js       # 通用功能
│   │   ├── ai_video.js   # AI分析功能
│   │   └── data_management.js # 数据管理功能
│   └── img/              # 图片资源
├── patients_data/         # 患者数据存储
│   └── {id}-{姓名}/      # 患者专属文件夹
│       ├── videos/       # 视频文件
│       ├── analysis_results/ # 分析结果
│       └── reports/      # 报告文件
├── model/                # AI模型文件
└── README.md            # 项目文档
```

## 核心功能模块

### 1. 用户认证系统
- **用户注册**: 支持新用户注册，自动创建用户配置
- **用户登录**: 基于YAML配置的用户认证
- **会话管理**: Flask Session安全会话管理
- **权限控制**: 登录验证装饰器保护敏感路由
- **角色管理**: 支持管理员和普通用户角色

### 2. 患者管理系统
- **患者信息管理**: 完整的患者信息录入、编辑、删除
- **智能搜索**: 支持按姓名、性别、年龄范围搜索
- **分页显示**: 支持大量患者数据的分页浏览
- **数据导出**: 支持患者数据导出功能
- **文件夹管理**: 自动创建和管理患者专属文件夹

#### 患者信息字段
- **基本信息**: 姓名、年龄、性别、身高、体重、地址
- **临床信息**: 肩部症状（疼痛、活动受限、脱臼、其他）、持续时间、治疗史（药物、针灸、康复理疗、关节封闭针、手术、其他）
- **项目信息**: 研究项目、填写人
- **AI评估**: 运动评分、综合评分、分析报告
- **时间记录**: 记录时间

### 3. AI视频分析系统

#### 视频管理功能
- **多角度上传**: 支持正面、侧面、背面三个角度的视频上传
- **文件验证**: 自动验证文件格式(MP4, AVI, MOV)和大小(16MB限制)
- **智能预览**: 自动检测患者视频并加载预览
- **文件操作**: 支持重新上传、删除视频文件
- **状态同步**: 前端状态与后端文件系统实时同步

#### AI姿态分析功能
- **实时姿态检测**: 使用YOLO模型进行人体关键点检测
- **角度计算**: 自动计算肩关节角度、角速度、角加速度
- **多角度分析**: 分别分析三个角度的视频，计算不同指标
- **肩部选择**: 支持选择左肩或右肩进行重点分析，影响侧面角度分析图表的显示
- **数据可视化**: 生成角度变化曲线、角度-速度分布图等
- **智能评估**: 基于分析数据自动生成功能评分和评估报告

#### 肩部选择功能详解
- **选择界面**: 在分析控制区域提供肩部选择下拉框，默认选择左肩
- **图表影响**: 选择左肩时，侧面角度分析图表只显示左肩曲线；选择右肩时，只显示右肩曲线
- **正面角度**: 正面角度分析图表不受肩部选择影响，始终显示左右肩两条曲线
- **报告生成**: Word报告包含完整的左右肩数据，不受肩部选择影响
- **数据完整性**: 分析过程中仍会计算所有肩部数据，只是在图表显示时进行选择性展示

#### 分析控制功能
- **后台分析**: 支持长时间运行的异步分析任务
- **进度监控**: 实时显示分析进度和状态
- **停止控制**: 支持中途停止分析任务
- **状态轮询**: 前端定期轮询分析状态
- **错误处理**: 完善的错误处理和状态反馈

#### 分析结果管理
- **结果存储**: 分析结果保存在患者专属目录
- **图表生成**: 自动生成PNG格式的分析图表
- **标注视频**: 生成带关键点和角度标注的视频文件，命名格式为"患者姓名-角度.avi"
- **数据导出**: 分析数据以JSON格式保存
- **报告生成**: 自动生成Word格式的详细分析报告

### 4. 报告系统
- **Word报告**: 自动生成包含图表、数据表格的Word格式报告
- **综合评估**: 基于多角度数据生成功能评分和评估结果
- **建议生成**: 根据分析结果自动生成康复建议
- **历史记录**: 显示患者所有分析报告的历史记录
- **报告管理**: 支持报告下载、删除等操作

### 5. 文件下载系统
- **统一下载**: 使用Fetch API + Blob的统一下载机制
- **直接下载**: 避免页面跳转，直接下载文件
- **进度提示**: 下载过程中显示友好的进度提示
- **错误处理**: 完善的错误处理和用户反馈
- **多格式支持**: 支持图片、视频、文档等多种文件类型

## API接口文档

### 用户认证API
```
POST /login          # 用户登录
POST /register       # 用户注册
GET  /logout         # 用户登出
```

### 患者管理API
```
GET    /api/patients                    # 获取患者列表
POST   /api/patients                    # 创建患者
GET    /api/patients/{id}               # 获取患者详情
PUT    /api/patients/{id}               # 更新患者信息
DELETE /api/patients/{id}               # 删除患者
GET    /api/patients/select             # 获取患者选择列表
GET    /api/patients/check_exists       # 检查患者是否存在
POST   /api/patients/{id}/create_folder # 创建患者文件夹
```

### 视频管理API
```
POST   /api/upload_video                # 上传视频
GET    /api/patients/{id}/videos/check  # 检查患者视频
GET    /api/patients/{id}/videos/{file} # 获取视频文件
DELETE /api/patients/{id}/videos/{file} # 删除视频文件
```

### AI分析API
```
POST   /api/analyze_video               # 开始分析
GET    /api/analysis_status/{id}        # 获取分析状态
POST   /api/stop_analysis/{id}          # 停止分析
GET    /api/export_results/{id}         # 导出分析结果
```

### 分析结果API
```
GET    /api/patients/{id}/analysis_results           # 获取分析结果
GET    /api/patients/{id}/analysis_results/{file}    # 获取结果文件
GET    /api/patients/{id}/reports/{file}             # 获取报告文件
GET    /api/patients/{id}/analysis_history           # 获取分析历史
DELETE /api/patients/{id}/reports/{file}             # 删除报告文件
```

## 安装和部署

### 环境要求
- Python 3.7+
- 8GB+ RAM (推荐16GB用于AI分析)
- 10GB+ 可用磁盘空间
- 支持CUDA的GPU (可选，用于加速AI分析)

### 安装步骤

1. **克隆项目**
```bash
git clone <repository-url>
cd pose-flask
```

2. **创建虚拟环境**
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate     # Windows
```

3. **安装依赖**
```bash
pip install -r requirements.txt
```

4. **配置用户信息**
编辑 `config.yaml` 文件：
```yaml
credentials:
  usernames:
    admin:
      email: admin@example.com
      name: 管理员
      password: your_password
      role: admin
```

5. **初始化数据库**
```bash
python -c "from app import db; db.create_all()"
```

6. **运行应用**
```bash
python app.py
```

7. **访问系统**
打开浏览器访问 `http://localhost:5000`

### 生产环境部署

1. **使用Gunicorn**
```bash
pip install gunicorn
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

2. **使用Nginx反向代理**
```nginx
server {
    listen 80;
    server_name your_domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## 使用指南

### 1. 系统登录
1. 访问系统首页，自动跳转到登录页面
2. 输入用户名和密码登录
3. 首次使用需要注册新用户

### 2. 患者管理
1. 点击"数据管理"进入患者管理页面
2. 点击"添加患者"创建新患者记录
3. 填写患者基本信息（姓名、年龄、性别等）
4. 使用搜索功能查找特定患者
5. 点击编辑或删除按钮管理患者信息

### 3. AI视频分析
1. 点击"AI视频分析"进入分析页面
2. 选择患者（系统会自动保存选择状态）
3. 上传三个角度的视频文件：
   - 正面视频 (front.mp4)
   - 侧面视频 (side.mp4)
   - 背面视频 (back.mp4)
4. 设置分析参数（置信度阈值等）
5. 点击"开始分析"进行AI评估
6. 实时监控分析进度
7. 查看分析结果和生成的图表
8. 下载Word格式的分析报告

### 4. 历史记录管理
1. 选择患者后自动加载历史分析记录
2. 查看报告文件名、生成时间、文件大小
3. 点击"下载"按钮下载Word报告
4. 点击"删除"按钮删除不需要的报告
5. 使用"刷新"按钮更新历史记录

### 5. 视频管理
1. 在视频上传区域管理视频文件
2. 点击"重新上传"覆盖现有视频
3. 点击"删除"移除不需要的视频
4. 使用"刷新预览"更新视频预览

## 系统特性

### 数据安全
- 用户认证和会话管理
- 文件上传验证和安全检查
- 数据库事务处理
- 患者数据隔离存储

### 用户体验
- 响应式设计，支持移动端
- 实时状态反馈和进度显示
- 直观的操作界面
- 完善的错误处理和提示
- 患者选择状态持久化

### 系统性能
- 文件大小限制和格式验证
- 分页加载大量数据
- 异步文件处理
- 后台分析任务管理
- 智能缓存机制

### 可扩展性
- 模块化代码结构
- 标准化的API接口
- 配置化的系统参数
- 支持多种文件格式
- 插件化的AI分析模块

## 故障排除

### 常见问题

1. **视频上传失败**
   - 检查文件格式是否为MP4、AVI或MOV
   - 确认文件大小不超过16MB
   - 检查网络连接和服务器状态

2. **AI分析失败**
   - 确认视频文件完整性
   - 检查系统内存是否充足
   - 验证YOLO模型文件是否存在

3. **患者选择问题**
   - 确保已创建患者记录
   - 检查浏览器本地存储是否正常
   - 尝试手动选择患者

4. **权限错误**
   - 确认用户登录状态
   - 检查用户角色权限
   - 重新登录系统

5. **文件下载问题**
   - 检查文件是否存在
   - 确认网络连接正常
   - 尝试刷新页面后重新下载

### 日志查看
- 系统运行日志显示在控制台
- 包含错误信息和调试信息
- 生产环境建议配置日志文件

### 性能优化
- 使用SSD存储提高文件访问速度
- 配置足够的内存用于AI分析
- 使用GPU加速YOLO模型推理
- 定期清理临时文件和缓存

## 更新日志

### v2.0.1 (2025年7月)
- 🔄 **患者切换优化**: 修复更换患者后页面状态不同步的问题
- 🧹 **状态清理完善**: 更换患者时自动清理所有相关状态（视频、分析、时间轴等）
- 📱 **界面同步**: 确保更换患者后界面完全刷新，显示新患者信息
- 🎯 **用户体验提升**: 更换患者流程更加流畅，避免信息混淆

### v2.0.0 (2025年7月)
- 🎉 **重大版本更新**: 重构整个系统架构，提升稳定性和性能
- 🔧 **技术栈升级**: 升级Flask到2.3.3，SQLAlchemy到3.0.5
- 🤖 **AI引擎优化**: 升级YOLO到8.0.196，提升分析精度
- 📊 **分析控制增强**: 实现真正的后台分析任务管理
- 📁 **文件管理优化**: 统一的文件下载机制，避免页面跳转
- 👥 **患者管理完善**: 患者选择状态持久化，自动文件夹管理
- 📈 **报告系统升级**: 智能报告生成，历史记录管理
- 🎨 **界面优化**: 响应式设计，现代化UI体验
- 🔒 **安全增强**: 完善的用户认证和权限控制
- 📱 **移动端适配**: 优化移动设备使用体验

### 主要改进
- ✅ 重构AI分析模块，提升分析精度和稳定性
- ✅ 优化文件管理系统，支持大文件处理
- ✅ 增强用户界面，提供更好的用户体验
- ✅ 完善错误处理机制，提高系统稳定性
- ✅ 优化数据库结构，提升查询性能
- ✅ 增强安全性，完善权限控制
- ✅ 改进文档系统，提供详细的使用说明
- ✅ 优化患者信息录入，肩部症状和治疗史改为下拉菜单选择

## 技术支持

### 联系方式
- 项目维护者: [维护者信息]
- 技术支持邮箱: [支持邮箱]
- 问题反馈: [反馈渠道]

### 贡献指南
欢迎提交Issue和Pull Request来改进项目。

### 许可证
本项目采用 [许可证类型] 许可证。

---

**重要声明**: 本系统仅供医疗辅助使用，最终诊断应由专业医生进行。系统分析结果仅供参考，不能替代专业医疗诊断。 