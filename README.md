# 肩关节体格检查AI评估系统

## 项目概述

这是一个基于Flask的肩关节体格检查AI评估系统，集成了患者管理、多角度视频AI分析等功能。系统采用前后端分离架构，提供直观的用户界面和强大的后端处理能力。

## 系统架构

### 技术栈
- **后端**: Flask + SQLAlchemy + SQLite
- **前端**: HTML5 + CSS3 + JavaScript + Bootstrap 5
- **AI分析**: OpenCV + Ultralytics YOLO
- **文件处理**: 视频上传、存储、预览
- **数据库**: SQLite (patients.db, user.db)

### 目录结构
```
pose-flask/
├── app.py                 # 主应用文件
├── config.yaml           # 用户配置文件
├── requirements.txt      # Python依赖
├── patients.db          # 患者数据库
├── user.db              # 用户数据库
├── patients_data/       # 患者数据存储目录
│   └── {id}-{姓名}/     # 患者专属文件夹
│       ├── videos/      # 视频文件存储
│       ├── analysis_results/  # 分析结果
│       └── reports/     # 报告文件
├── templates/           # HTML模板
├── static/             # 静态资源
│   ├── css/           # 样式文件
│   └── js/            # JavaScript文件
└── README.md          # 项目说明文档
```

## 核心功能

### 1. 用户认证系统
- **登录/注册**: 支持用户注册和登录
- **会话管理**: 基于Flask Session的安全会话管理
- **权限控制**: 登录验证装饰器保护敏感路由

### 2. 患者管理系统
- **患者信息管理**: 完整的患者信息录入、编辑、删除
- **患者搜索**: 支持按姓名、性别、年龄范围搜索
- **分页显示**: 支持大量患者数据的分页浏览
- **数据导出**: 支持患者数据导出功能

#### 患者信息字段
- 基本信息: 姓名、年龄、性别、身高、体重
- 医疗信息: 诊断、治疗记录、病程、项目
- 地址信息: 详细地址
- 记录信息: 填写人、记录时间
- AI评估: 运动评分、综合评分、分析报告

### 3. AI视频分析系统

#### 视频上传功能
- **多角度视频**: 支持正面、侧面、背面三个角度的视频上传
- **文件验证**: 自动验证文件格式(MP4, AVI, MOV)和大小(100MB限制)
- **智能预览**: 自动检测患者视频并加载预览
- **重新上传**: 支持覆盖现有视频文件，提供确认对话框
- **视频删除**: 支持删除已上传的视频文件

#### 视频管理特性
- **患者专属存储**: 每个患者在`patients_data/{id}-{姓名}/videos/`目录下存储视频
- **标准化命名**: 视频自动重命名为`front.mp4`、`side.mp4`、`back.mp4`
- **状态同步**: 前端状态与后端文件系统实时同步
- **批量操作**: 支持批量上传多个视频文件

#### 分析功能
- **多角度分析**: 分别分析三个角度的视频
- **综合分析**: 基于多角度视频的综合评估
- **实时分析**: 支持分析过程监控和控制
- **结果导出**: 支持分析结果导出为ZIP文件

### 4. 用户界面特性

#### 患者选择界面
- **模态框设计**: 美观的患者选择模态框
- **搜索功能**: 实时搜索患者姓名
- **状态提示**: 未选患者时显示醒目提示
- **选中状态**: 选中患者时显示患者信息卡片

#### 视频上传界面
- **下拉式设计**: 可展开收起的视频上传区域
- **状态指示**: 清晰的上传状态指示器
- **进度显示**: 实时上传进度条
- **操作按钮**: 重新上传和删除按钮

#### 视频预览界面
- **自动加载**: 检测到视频后自动加载预览
- **响应式设计**: 适配不同屏幕尺寸
- **交互优化**: 悬停效果和动画

## API接口文档

### 患者管理API

#### 获取患者列表
```
GET /api/patients
参数: page, page_size, search, gender, age_range
返回: 患者列表数据，包含分页信息
```

#### 创建患者
```
POST /api/patients
参数: 患者信息JSON
返回: 创建成功状态和患者ID
```

#### 获取患者详情
```
GET /api/patients/{patient_id}
返回: 患者详细信息
```

#### 更新患者信息
```
PUT /api/patients/{patient_id}
参数: 更新的患者信息JSON
返回: 更新成功状态
```

#### 删除患者
```
DELETE /api/patients/{patient_id}
返回: 删除成功状态
```

### 视频管理API

#### 上传视频
```
POST /api/upload_video
参数: video文件, angle角度, patientId患者ID
返回: 上传成功状态和文件信息
特性: 自动覆盖现有文件，返回覆盖状态
```

#### 检查患者视频
```
GET /api/patients/{patient_id}/videos/check
返回: 三个角度视频的存在状态和URL
```

#### 获取视频文件
```
GET /api/patients/{patient_id}/videos/{filename}
返回: 视频文件流
```

#### 删除视频文件
```
DELETE /api/patients/{patient_id}/videos/{filename}
返回: 删除成功状态
```

### 分析API

#### 开始分析
```
POST /api/analyze_video
参数: videos视频信息, analysisType分析类型, confidenceThreshold置信度阈值, patientId患者ID
返回: 分析结果
```

#### 停止分析
```
POST /api/stop_analysis/{analysis_id}
返回: 停止成功状态
```

#### 导出结果
```
GET /api/export_results/{analysis_id}
返回: ZIP格式的分析结果文件
```

## 安装和部署

### 环境要求
- Python 3.7+
- Flask 2.0+
- 其他依赖见requirements.txt

### 安装步骤
1. 克隆项目到本地
2. 安装Python依赖: `pip install -r requirements.txt`
3. 配置config.yaml文件
4. 运行应用: `python app.py`

### 配置说明
在`config.yaml`中配置用户信息：
```yaml
credentials:
  usernames:
    admin:
      email: admin@example.com
      name: 管理员
      password: admin123
      role: admin
```

## 使用指南

### 1. 患者管理
1. 登录系统后进入数据管理页面
2. 点击"添加患者"创建新患者
3. 填写患者基本信息
4. 使用搜索和筛选功能查找患者
5. 点击编辑或删除按钮管理患者信息

### 2. AI视频分析
1. 进入AI视频分析页面
2. 选择患者（如无患者会提示创建）
3. 上传三个角度的视频文件
4. 系统自动检测并预览视频
5. 点击"开始分析"进行AI评估
6. 查看分析结果并导出报告

### 3. 视频重新上传
1. 在视频上传区域点击"重新上传"按钮
2. 系统会提示确认覆盖现有文件
3. 选择新视频文件进行上传
4. 上传完成后视频预览会自动更新

### 4. 视频删除
1. 在视频上传区域点击"删除"按钮
2. 确认删除操作
3. 视频文件将从服务器删除
4. 界面状态会同步更新

## 系统特性

### 数据安全
- 用户认证和会话管理
- 文件上传验证和安全检查
- 数据库事务处理

### 用户体验
- 响应式设计，支持移动端
- 实时状态反馈
- 直观的操作界面
- 完善的错误处理

### 系统性能
- 文件大小限制和格式验证
- 分页加载大量数据
- 异步文件处理
- 缓存机制优化

### 可扩展性
- 模块化代码结构
- 标准化的API接口
- 配置化的系统参数
- 支持多种文件格式

## 故障排除

### 常见问题
1. **视频上传失败**: 检查文件格式和大小限制
2. **患者选择问题**: 确保已创建患者记录
3. **分析失败**: 检查视频文件完整性
4. **权限错误**: 确认用户登录状态

### 日志查看
系统运行日志会显示在控制台，包含错误信息和调试信息。

## 更新日志

### v2.0.0 (最新)
- ✅ 新增视频重新上传功能
- ✅ 新增视频删除功能
- ✅ 优化视频预览更新逻辑
- ✅ 改进用户界面交互体验
- ✅ 增强错误处理和状态管理
- ✅ 完善系统文档

### v1.0.0
- ✅ 基础患者管理功能
- ✅ 视频上传和分析功能
- ✅ 用户认证系统
- ✅ 基础UI界面

## 技术支持

如有问题或建议，请联系开发团队。

---

**注意**: 本系统仅供医疗辅助使用，最终诊断应由专业医生进行。 